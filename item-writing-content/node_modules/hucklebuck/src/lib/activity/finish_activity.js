/* eslint-env browser, jquery */
import { bus } from 'partybus';
import $ from 'jquery';

let COMPLETION_THIS_SESSION = false;

const closeTheActivity = () => window.close();
const closeTheActivityDelayed = () => {
  setTimeout( () => closeTheActivity(), 2000 );
}
const refreshTheActivity = () => window.location.href = window.location.href;
const refreshTheActivityDelayed = () => {
  setTimeout( () => refreshTheActivity(), 2000 );
}

const check_activity_completion = (sections) => {
  if (sections.filter(i => !i.completed).length === 0) {
    mark_completed();
  }
};

const mark_completed = () => {
  if (COMPLETION_THIS_SESSION) {
    console.log("mark_completed called... already completed");
    return false; // do not send completion message more than once per session
  }
  console.log("✔︎ MARK COMPLETED");
  bus.emit('activity::progress::mark_as_completed');
  COMPLETION_THIS_SESSION = true;
};

bus.on('activity::progress::updated', check_activity_completion);
bus.on('window::reload', refreshTheActivityDelayed);
bus.on('window::close', closeTheActivity);

$(document).on('click', '.window-close', closeTheActivity);
$(document).on('click', '.window-close-delay', closeTheActivityDelayed);
$(document).on('click', '#trump', closeTheActivityDelayed);
$(document).on('click', '.activity-completed', () => mark_completed );

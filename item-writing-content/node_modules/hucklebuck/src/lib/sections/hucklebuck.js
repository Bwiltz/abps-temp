/* eslint-env browser, jquery */
import { bus } from 'partybus';
import './hucklebuck_buttons';


const sections_prefetched = {};
const sections_order = [];
window.current_section = '';

const getSlugFromIndex = (i) => sections_order[i];

const getSlugNext = (slug) => {
  const index = sections_order.indexOf(slug);
  if (index > sections_order - 1) return null;
  return sections_order[index + 1];
};

const getSlugPrev = (slug) => {
  const index = sections_order.indexOf(slug);
  if (index <= 0) return null;
  return sections_order[index - 1];
};

const renderSectionBySlug = (slug) => {
  console.log(`Rendering Section by Slug: ${slug}`);
  if (sections_prefetched[slug] !== undefined) {
    document.getElementById('content').innerHTML = sections_prefetched[slug];
    bus.emit('hucklebucked', slug);
  } else {
    document.getElementById('content').innerHTML = sections_prefetched['404'];
    bus.emit('404page');
  }
};

const hucklebuck = (slug) => {
  console.log('hucklebuck called', slug);
  if (Number.isInteger(slug)) {
    slug = getSlugFromIndex(slug);
  } else if (slug === 'next') {
    slug = getSlugNext(window.current_section);
  } else if (slug === 'prev') {
    slug = getSlugPrev(window.current_section);
  }
  if (slug !== null) renderSectionBySlug(slug);
};

bus.on('section::loaded', (obj) => {
  sections_prefetched[obj.slug] = obj.body;
  sections_order[obj.order] = obj.slug;
});

bus.on('sections::all_loaded', () => {
  console.log("sections::all_loaded => sections::render", sections_prefetched);
  bus.emit('sections::render', sections_prefetched);
});

bus.on('hucklebuck', hucklebuck);

bus.on('hucklebucked', (slug) => window.current_section = slug );

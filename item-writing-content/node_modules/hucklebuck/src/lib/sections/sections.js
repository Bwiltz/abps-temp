/* eslint-env browser, jquery */
import { bus } from 'partybus';
import './hucklebuck';
import './404';

const { fetch } = window;

const loadFirstPage = (slug) => {
  console.log('loading First Page', slug);
  bus.emit('hucklebuck', slug);
};

const errorOrBody = (response) => {
  if (!response.ok) {
    throw Error(response.statusText);
  }
  return response.text();
}

const prefetchSections = (manifest) => {
  console.log(' => prefetchSections called', manifest);
  bus.emit('activity::progress::setup', manifest);
  bus.on(`section::loaded::${manifest[0].slug}`, () => loadFirstPage(manifest[0].slug));
  Promise.all(manifest.map((s, order) => {
    return fetch(`sections/${s.slug}.html`)
      .then(errorOrBody)
      .then((body) => {
        bus.emit('section::loaded', { slug:s.slug, order:order, body:body });
        console.log(`section::loaded::${s.slug}`, order);
        bus.emit(`section::loaded::${s.slug}`);
        return true;
      })
      .catch((err) => {
        console.log(`section::failed::${s.slug}`);
        bus.emit('section::failed_to_load', s.slug);
      });
  })).then(() => bus.emit('sections::all_loaded'));
};

export default prefetchSections;

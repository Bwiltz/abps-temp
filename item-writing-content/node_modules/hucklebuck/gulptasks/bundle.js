var gulp = require('gulp');
const watchify = require('watchify');
const browserify = require('browserify');
const uglify = require('gulp-uglify');
const browserSync = require('browser-sync');
const sourcemaps = require('gulp-sourcemaps');
const size = require('gulp-size');
const source = require('vinyl-source-stream');
const buffer = require('vinyl-buffer');
const plumber = require('gulp-plumber');

const customOpts = {
  entries: [ './src/js/index.js' ],
  debug: true,
  transform: [
    [ 'babelify', { presets: [ 'es2015' ], ignore: [ './src/libs/**' ] } ]
  ],
  ignore: [ './src/libs/**' ]
};
const opts = Object.assign({}, watchify.args, customOpts);
const b = watchify(browserify(opts));

/**
 * This task will bundle all other js files and babelify them.
 * If you want to add other processing to the main js files, add your code here.
 */
const bundlejs = function(config) {
  return function() {
    return b.bundle().on('error', function(err) {
      console.log(err.message);
      browserSync.notify(err.message, 3000);
      this.emit('end');
    }).pipe(
      plumber()
    ).pipe(source('app.js')).pipe(buffer()).pipe(uglify()).pipe(sourcemaps.init({ loadMaps: true })).pipe(sourcemaps.write('./')).pipe(size()).pipe(gulp.dest(config.distpath));
  };
};

module.exports = bundlejs;
